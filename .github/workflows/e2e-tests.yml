name: Android E2E Tests

on:
  workflow_dispatch:
  pull_request:
    types: [opened, synchronize, reopened, labeled, unlabeled]
    branches: [master]
  push:
    branches: [master]

jobs:
    e2e:
        if: github.event_name == 'workflow_dispatch' || (github.event_name == 'pull_request' && contains(github.event.pull_request.labels.*.name, 'run-android-e2e'))
        runs-on: ubuntu-latest # Linux with KVM is 2-3x faster and free vs macOS

        steps:
            - name: Checkout Code
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: '24'
                  cache: 'npm'

            - name: Set up JDK 21
              uses: actions/setup-java@v4
              with:
                  java-version: '21'
                  distribution: 'temurin'
                  cache: gradle

            - name: Install Node Dependencies
              run: npm ci

            - name: Build Web Assets & Sync Capacitor
              run: npm run sync

            - name: Build Debug APK
              working-directory: ./android
              run: ./gradlew assembleDebug

            - name: Enable KVM group perms
              run: |
                  echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
                  sudo udevadm control --reload-rules
                  sudo udevadm trigger --name-match=kvm

            - name: Run E2E Tests on Emulator
              uses: reactivecircus/android-emulator-runner@v2
              with:
                  api-level: 36
                  target: google_apis
                  arch: x86_64
                  profile: pixel_5
                  # The WDIO appium service handles starting/stopping the Appium server
                  script: npm run test:e2e
