name: Deploy to GitHub Pages

on:
  push:
    branches: ["**"]
  release:
    types: [published]
  delete:
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

concurrency:
  group: "pages-deploy"
  cancel-in-progress: false

jobs:
  deploy:
    runs-on: ubuntu-latest
    # Don't run on pushes to gh-pages itself
    if: github.ref != 'refs/heads/gh-pages'
    steps:
      - name: Checkout source
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      # ── Prepare gh-pages branch ──────────────────────────────
      - name: Prepare gh-pages branch
        run: |
          # Fetch gh-pages if it exists, otherwise create an orphan
          if git ls-remote --heads origin gh-pages | grep -q gh-pages; then
            git fetch origin gh-pages
            git worktree add ../gh-pages gh-pages
          else
            git worktree add --detach ../gh-pages
            cd ../gh-pages
            git checkout --orphan gh-pages
            git rm -rf . 2>/dev/null || true
            echo "# GitHub Pages" > README.md
            echo '["stable"]' > branches.json
            git add .
            git commit -m "Initialize gh-pages"
          fi

      # ── Define app files to copy ─────────────────────────────
      # Copy all files from src directly to the deployment folder
      - name: Deploy branch
        if: github.event_name == 'push'
        run: |
          BRANCH_NAME="${GITHUB_REF#refs/heads/}"
          echo "Deploying branch: $BRANCH_NAME"

          # Create branch directory in gh-pages
          mkdir -p "../gh-pages/$BRANCH_NAME"

          # Copy app files
          cp -r src/* "../gh-pages/$BRANCH_NAME/"

          # Update branches.json manifest
          cd ../gh-pages
          # Build the list from directories that contain index.html
          echo -n '["stable"' > branches.json
          for dir in */; do
            dir="${dir%/}"
            if [ -f "$dir/index.html" ] && [ "$dir" != "stable" ]; then
              echo -n ",\"$dir\"" >> branches.json
            fi
          done
          echo ']' >> branches.json

          git add .
          git diff --cached --quiet || git commit -m "Deploy branch: $BRANCH_NAME"
          git push origin gh-pages

      # ── Handle release publish ───────────────────────────────
      - name: Deploy release to root
        if: github.event_name == 'release'
        run: |
          TAG="${GITHUB_REF#refs/tags/}"
          echo "Deploying release: $TAG"

          # Check out the tagged version
          git checkout "$TAG"

          # Copy app files to gh-pages root
          cp -r src/* "../gh-pages/"

          cd ../gh-pages
          git add .
          git diff --cached --quiet || git commit -m "Deploy release: $TAG"
          git push origin gh-pages

      # ── Handle branch delete ─────────────────────────────────
      - name: Clean up deleted branch
        if: github.event_name == 'delete' && github.event.ref_type == 'branch'
        env:
          BRANCH_NAME: ${{ github.event.ref }}
        run: |
          echo "Cleaning up branch: $BRANCH_NAME"

          cd ../gh-pages
          if [ -d "$BRANCH_NAME" ]; then
            rm -rf "$BRANCH_NAME"

            # Rebuild branches.json
            echo -n '["stable"' > branches.json
            for dir in */; do
              dir="${dir%/}"
              if [ -f "$dir/index.html" ] && [ "$dir" != "stable" ]; then
                echo -n ",\"$dir\"" >> branches.json
              fi
            done
            echo ']' >> branches.json

            git add .
            git diff --cached --quiet || git commit -m "Remove branch: $BRANCH_NAME"
            git push origin gh-pages
          fi
